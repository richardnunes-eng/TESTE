<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THX LOG | Centro de Comando</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="preload" href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" as="style">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">

    <?!= include('CSS-Estilos'); ?>
</head>

<body>

  

    <div id="loader" class="startup-loader">
        <div class="loader-shell">
            <img src="https://drive.google.com/thumbnail?id=1Ft7TTx-y4bLisPyCnBeXZmh9gPgLFZ1T&sz=w500" class="loader-logo" alt="Logo THX LOG">
            <div class="loader-pulse-line"></div>
            <div class="loader-tagline">Foco no foco do cliente</div>
            <div class="loader-sub">Centro de Comando</div>
            <div class="loader-bar"><div class="loader-bar-fill"></div></div>
            <div class="loader-quote" id="loaderQuote">Atualizando informações...</div>
            <div class="loader-quote-author" id="loaderQuoteAuthor"></div>
        </div>
    </div>
    <div class="modal-overlay" id="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-box">
            <div class="modal-header">
                <div><h3 id="mTitle">Detalhes</h3><p id="mSub" style="font-size: 0.9rem; color: var(--text-muted);">...</p></div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <a id="btnClickup" class="btn-clickup" href="#" target="_blank" style="display:none;">
                        <img src="https://clickup.com/landing/images/logo-clickup_color.svg" width="16" style="filter: brightness(0) invert(1);"> Abrir ClickUp
                    </a>
                    <button onclick="closeModal()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><span class="material-icons-round" style="font-size: 1.5rem;">close</span></button>
                </div>
            </div>
            <div class="modal-content" id="mContent"></div>
        </div>
    </div>

    <button class="theme-toggle" id="themeToggle"><span class="material-icons-round" id="themeIcon">dark_mode</span></button>

    <nav class="sidebar">
        <div class="brand-container">
            <img src="https://drive.google.com/thumbnail?id=1Ft7TTx-y4bLisPyCnBeXZmh9gPgLFZ1T&sz=w500" class="brand-logo">
            <div class="brand-separator"></div><p class="brand-tagline">FOCO NO FOCO DO CLIENTE</p>
        </div>
        <ul class="menu-list">
            <li class="menu-item active" onclick="switchSection('dashboard', this)"><span class="material-icons-round menu-icon">dashboard</span> Visão Geral</li>
            <li class="menu-item" onclick="switchSection('ocorrencias', this)"><span class="material-icons-round menu-icon">build_circle</span> Ocorrencias</li>
            <li class="menu-item" onclick="setFilter('FINALIZADO', this); switchSection('dashboard', document.querySelector('.menu-item:first-child'))"><span class="material-icons-round menu-icon">task_alt</span> Finalizados</li>
        </ul>
    </nav>

    <div class="main-content">
        <div id="dashboard-section">
            <div class="header-bar">
                <div class="page-title"><h1>Visão Operacional</h1><p>Monitoramento Logístico em Tempo Real</p></div>
             <div class="header-actions">
                    <div class="search-wrapper">
                        <span class="material-icons-round search-icon">search</span>
                        <input type="text" id="searchInput" placeholder="Buscar..." onkeyup="onSearchInput()">
                    </div>
                    <div class="date-range-container">
                        <span class="material-icons-round" style="color:var(--primary);">calendar_today</span>
                <input type="date" id="dateStart" class="date-input-clean">
                <span class="date-separator">ATÉ</span>
                <input type="date" id="dateEnd" class="date-input-clean">
                    </div>
                    <button class="btn-refresh" id="refreshBtn" onclick="loadData('force', { syncClickup: true })"><span class="material-icons-round" id="refreshIcon">sync</span></button>
                    <button class="btn-export" id="exportBtn" onclick="exportXlsx()"><span class="material-icons-round">file_download</span> Exportar XLSX</button>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card blue" onclick="clickKpi('ALL')"><span class="material-icons-round kpi-icon-bg">directions_car</span><div class="kpi-val" id="kpiTotal">0</div><div class="kpi-lbl">Total Frota</div></div>
                <div class="kpi-card info" onclick="clickKpi('EM_ROTA')"><span class="material-icons-round kpi-icon-bg">local_shipping</span><div class="kpi-val" id="kpiRota" style="color: #3B82F6;">0</div><div class="kpi-lbl">Em Trânsito</div></div>
                <div class="kpi-card danger" onclick="clickKpi('CRITICO')"><span class="material-icons-round kpi-icon-bg">warning</span><div class="kpi-val" id="kpiCrit" style="color: var(--danger);">0</div><div class="kpi-lbl">Atrasados / Críticos</div></div>
                <div class="kpi-card success" onclick="clickKpi('FINALIZADO')"><span class="material-icons-round kpi-icon-bg">check_circle</span><div class="kpi-val" id="kpiFinal" style="color: var(--accent);">0</div><div class="kpi-lbl">Finalizados</div></div>
            </div>

            <div class="filters-advanced-row">
                <div class="custom-dropdown" id="dd-unidade">
                    <button class="dropdown-btn" onclick="toggleDropdown('dd-unidade')">
                        <span class="material-icons-round" style="font-size:18px">business</span> Unidade
                        <span class="material-icons-round" style="font-size:16px">expand_more</span>
                    </button>
                    <div class="dropdown-content" id="list-unidade"></div>
                </div>

                <div class="custom-dropdown" id="dd-veiculo">
                    <button class="dropdown-btn" onclick="toggleDropdown('dd-veiculo')">
                        <span class="material-icons-round" style="font-size:18px">local_shipping</span> Veículo
                        <span class="material-icons-round" style="font-size:16px">expand_more</span>
                    </button>
                    <div class="dropdown-content" id="list-veiculo"></div>
                </div>
            </div>

            <div class="controls-bar">
               <div class="filters">
                  <button class="filter-btn active" onclick="setQuickFilter('ALL', this)">TODOS</button>
                  <button class="filter-btn" onclick="setQuickFilter('EM_ROTA', this)">EM ROTA</button>
                  <button class="filter-btn" onclick="setQuickFilter('CRITICO', this)">CRÍTICOS</button>
                  <button class="filter-btn" onclick="setQuickFilter('RESSALVA', this)">RESSALVAS</button>
                  <button class="filter-btn" onclick="setQuickFilter('FINALIZADO', this)">FINALIZADOS</button>
            </div>
                <div class="view-toggles">
                    <button class="view-btn active" id="btnGrid" onclick="setView('grid')"><span class="material-icons-round">grid_view</span></button>
                    <button class="view-btn" id="btnTable" onclick="setView('table')"><span class="material-icons-round">table_rows</span></button>
                </div>
            </div>

            <div class="grid-drivers" id="grid"></div>
            <div class="table-container" id="tableView">
                <table class="data-table">
                    <tr>
                            <th onclick="sortPipeline('statusLabel')">Status <span class="material-icons-round sort-icon">sort</span></th>
                            <th onclick="sortPipeline('motorista')">Motorista <span class="material-icons-round sort-icon">sort</span></th>
                            <th onclick="sortPipeline('veiculo')">Veículo <span class="material-icons-round sort-icon">sort</span></th>
                            
                            <th onclick="sortPipeline('unidade')">Unidade <span class="material-icons-round sort-icon">sort</span></th>
                            
                            <th onclick="sortPipeline('plano')">Plano <span class="material-icons-round sort-icon">sort</span></th>
                            <th onclick="sortPipeline('dataSaida')">Saída <span class="material-icons-round sort-icon">sort</span></th>
                            <th onclick="sortPipeline('progresso')">Progresso <span class="material-icons-round sort-icon">sort</span></th>
                            <th onclick="sortPipeline('entregas')">Entregas <span class="material-icons-round sort-icon">sort</span></th>
                            <th onclick="sortPipeline('peso')">Peso <span class="material-icons-round sort-icon">sort</span></th>
                            <th onclick="sortPipeline('valorTotal')">Valor Total <span class="material-icons-round sort-icon">sort</span></th>
                        </tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="ocorrencias-section" style="display:none;">
            <div class="header-bar">
                <div class="page-title"><h1>Ocorrencias</h1><p>Ocorrencias registradas no ClickUp</p></div>
                <div class="header-actions">
                      <div class="search-wrapper">
                          <span class="material-icons-round search-icon">search</span>
                          <input type="text" id="occSearchInput" placeholder="Buscar ocorrencias..." onkeyup="onOccSearchInput()">
                      </div>
                      <button class="btn-refresh" id="occRefreshBtn" onclick="startOcorrenciasManualSync()" style="margin-left:10px;"><span class="material-icons-round">sync</span></button>
                      <div class="view-toggles">
                          <button class="view-btn active" id="occBtnGrid" onclick="setOccView('grid')"><span class="material-icons-round">grid_view</span></button>
                        <button class="view-btn" id="occBtnTable" onclick="setOccView('table')"><span class="material-icons-round">table_rows</span></button>
                    </div>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card blue"><span class="material-icons-round kpi-icon-bg">assignment</span><div class="kpi-val" id="occKpiTotal">0</div><div class="kpi-lbl">Total</div></div>
                <div class="kpi-card info"><span class="material-icons-round kpi-icon-bg">hourglass_top</span><div class="kpi-val" id="occKpiOpen" style="color:#3B82F6;">0</div><div class="kpi-lbl">Em Aberto</div></div>
                <div class="kpi-card danger"><span class="material-icons-round kpi-icon-bg">warning</span><div class="kpi-val" id="occKpiLate" style="color:var(--danger);">0</div><div class="kpi-lbl">Atrasadas</div></div>
                <div class="kpi-card success"><span class="material-icons-round kpi-icon-bg">check_circle</span><div class="kpi-val" id="occKpiClosed" style="color:var(--accent);">0</div><div class="kpi-lbl">Finalizadas Hoje</div></div>
                <div class="kpi-card blue"><span class="material-icons-round kpi-icon-bg">schedule</span><div class="kpi-val" id="occKpiAvg">--</div><div class="kpi-lbl">Tempo Médio</div></div>
            </div>

            <div class="filters-advanced-row">
                <div class="input-wrapper select-wrapper">
                    <span class="material-icons-round input-icon">business</span>
                    <select id="occFilterUnidade"><option value="">Todas as Unidades</option></select>
                </div>
                <div class="input-wrapper select-wrapper">
                    <span class="material-icons-round input-icon">flag</span>
                    <select id="occFilterStatus"><option value="">Todos os Status</option></select>
                </div>
                <div class="input-wrapper select-wrapper">
                    <span class="material-icons-round input-icon">report_problem</span>
                    <select id="occFilterMotivo"><option value="">Todos os Motivos</option></select>
                </div>
                <div class="input-wrapper select-wrapper">
                    <span class="material-icons-round input-icon">precision_manufacturing</span>
                    <select id="occFilterCausador"><option value="">Todos os Causadores</option></select>
                </div>
                <div class="input-wrapper select-wrapper">
                    <span class="material-icons-round input-icon">person_pin</span>
                    <select id="occFilterMotorista"><option value="">Todos os Motoristas</option></select>
                </div>
                <div class="input-wrapper select-wrapper">
                    <span class="material-icons-round input-icon">alt_route</span>
                    <select id="occFilterRota"><option value="">Todas as Rotas</option></select>
                </div>
            </div>

            <div class="date-range-container" style="margin: 10px 0 20px 0;">
                <span class="material-icons-round" style="color:var(--primary);">calendar_today</span>
                <input type="date" id="occDateStart" class="date-input-clean">
                <span class="date-separator">ATÉ</span>
                <input type="date" id="occDateEnd" class="date-input-clean">
            </div>

            <div class="occ-progress-row" style="display:flex; align-items:center; gap:10px; padding:8px 0;">
                <span id="occProgressText" style="font-size:0.9rem; color:var(--text-muted);">Aguardando carregamento...</span>
                <span id="occErrorText" style="font-size:0.9rem; color:var(--danger); display:none;"></span>
                <button class="btn-export" id="occRetryBtn" onclick="retryOcorrencias()" style="margin-left:auto; display:none;">Tentar novamente</button>
            </div>

            <div class="grid-drivers" id="occGrid"></div>
            <div class="table-container" id="occTableView" style="display:none;">
                <table class="data-table">
                    <tr>
                        <th>Status</th>
                        <th>Ocorrencia</th>
                        <th>Cliente</th>
                        <th>Motorista</th>
                        <th>Rota</th>
                        <th>Criado em</th>
                        <th>Finalizado em</th>
                        <th>Tempo</th>
                    </tr>
                    <tbody id="occTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
                                        <div id="quickActionMenu" class="quick-menu">
                          <div class="menu-header">Ações Rápidas</div>
                          
                          <button onclick="actionClickup()">
                              <span class="material-icons-round" style="color:#7b68ee;">open_in_new</span> 
                              <span>Abrir no ClickUp</span>
                          </button>

                          <button onclick="actionAdiantamento()">
                              <span class="material-icons-round" style="color:var(--accent);">payments</span> 
                              <span>Solicitar Adiantamento</span>
                          </button>

                          <button onclick="actionDebito()">
                              <span class="material-icons-round" style="color:var(--danger);">receipt_long</span> 
                              <span>Lançar Débito</span>
                          </button>

                          <button onclick="actionFinalizar()">
                              <span class="material-icons-round" style="color:var(--primary);">task_alt</span> 
                              <span>Finalizar Tarefa</span>
                          </button>

                          <div class="menu-sep"></div>

                          <button onclick="actionDetalhes()" class="btn-detalhes">
                              <span class="material-icons-round">visibility</span> 
                              <span>Ver Detalhes / Rota</span>
                          </button>
    </div>

    <div id="clickupStatusMenu" class="quick-menu clickup-status-menu">
        <div class="menu-header">Status ClickUp</div>
        <div id="clickupStatusOptions" class="status-options"></div>
    </div>

   <div id="clickupSuccessOverlay" class="c-success-overlay">
    <div class="c-success-box">
         <div class="icon-container-pop">
            <div class="c-ripple r1"></div>
            <div class="c-ripple r2"></div>
            <div class="c-ripple r3"></div>
            
            <span class="material-icons-round c-check-icon">task_alt</span>
         </div>
         
         <h2 class="pop-text-title" id="clickupOverlayTitle">Finalizado!</h2>
         <p class="pop-text-sub" id="clickupOverlaySub">Sincronizado com sucesso no ClickUp.</p>
    </div>
</div>

    <?!= include('JS-Logica'); ?>

    <div id="toastNotification" class="toast-box">
    <span class="material-icons-round" id="toastIcon">content_copy</span>
    <span id="toastText" style="font-weight:600;">Telefone copiado!</span>
</div>

<div id="globalLoader" class="loader-overlay" style="display: none;">
    <div class="loader-content">
        <div class="spinner-border"></div>
        <h3 id="loaderText">Carregando...</h3>
    </div>
</div>

</body>

<script>
  // ✅ CRIAR ARQUIVO SEPARADO: worker-filter.js
// Cole no Dashboard.html como script inline ou use Blob

const filterWorkerCode = `
self.onmessage = function(e) {
    const { drivers, filters, sort } = e.data;
    let result = [...drivers];
    
    // Filtro de data
    const effectiveEnd = filters.dateEnd || filters.dateStart;
    if (filters.dateStart || effectiveEnd) {
        result = result.filter(d => {
            if (!d.dataSaidaIso) return false;
            if (filters.dateStart && d.dataSaidaIso < filters.dateStart) return false;
            if (effectiveEnd && d.dataSaidaIso > effectiveEnd) return false;
            return true;
        });
    }
    
    // Filtro de status
    if (filters.status !== 'ALL') {
        result = result.filter(d => d.status === filters.status);
    }
    
    // Ordenação
    if (sort.key) {
        result.sort((a, b) => {
            let valA = a[sort.key] || "";
            let valB = b[sort.key] || "";
            if (sort.key === 'valorTotal' || sort.key === 'progresso') {
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;
            }
            return sort.asc ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
        });
    }
    
    self.postMessage(result);
};
`;

// ✅ USO NO JS-Logica.html
let filterWorker;
function initWorker() {
    const blob = new Blob([filterWorkerCode], { type: 'application/javascript' });
    filterWorker = new Worker(URL.createObjectURL(blob));
    
    filterWorker.onmessage = (e) => {
        const result = e.data;
        updateKPIs(result);
        if (state.viewMode === 'grid') renderGrid(result);
        else renderTable(result);
        hideGlobalLoader();
    };
}

function applyPipelineAsync() {
    filterWorker.postMessage({
        drivers: state.allDrivers,
        filters: {
            status: state.filters.status,
            dateStart: DOM.dateStart?.value,
            dateEnd: DOM.dateEnd?.value
        },
        sort: state.sort
    });
}
</script>
</html>
